import React, { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Textarea } from '@/components/ui/textarea';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { useToast } from '@/hooks/use-toast';
import { Loader2, Sparkles, Copy, CheckCircle } from 'lucide-react';

interface TaskConfig {
  fields: Array<{
    type: string;
    id: string;
    label: string;
    options?: Array<{ value: string | number; label: string }>;
    default?: string | number;
    placeholder?: string;
  }>;
}

interface GeneratedContent {
  meta: {
    task: string;
    platform: string;
    language: string;
    tone: string;
    variations_count: number;
  };
  summary: string;
  variations: Array<{
    id: string;
    title: string;
    content: string;
    character_count?: number;
    word_count?: number;
    hashtags?: string[];
    cta?: string;
    notes?: string;
    formatted_content?: string;
  }>;
  seo?: {
    title: string;
    description: string;
  };
}

const TASK_CONFIGS: Record<string, TaskConfig> = {
  'Social Caption': {
    fields: [
      {
        type: 'select',
        id: 'characterLimit',
        label: 'Character Limit',
        options: [
          { value: 140, label: '140 (Twitter Short)' },
          { value: 280, label: '280 (Twitter)' },
          { value: 500, label: '500 (LinkedIn)' },
          { value: 1000, label: '1000 (Instagram)' },
          { value: 2000, label: '2000 (Facebook)' }
        ],
        default: 280
      }
    ]
  },
  'Script': {
    fields: [
      {
        type: 'select',
        id: 'scriptLength',
        label: 'Script Length',
        options: [
          { value: '30 seconds', label: '30 seconds' },
          { value: '1 minute', label: '1 minute' },
          { value: '2 minutes', label: '2 minutes' },
          { value: '3 minutes', label: '3 minutes' },
          { value: '5 minutes', label: '5 minutes' },
          { value: '10 minutes', label: '10 minutes' }
        ],
        default: '2 minutes'
      },
      {
        type: 'select',
        id: 'scriptType',
        label: 'Script Type',
        options: [
          { value: 'Educational', label: '📚 Educational' },
          { value: 'Entertainment', label: '🎭 Entertainment' },
          { value: 'Commercial', label: '📺 Commercial' },
          { value: 'Explainer', label: '💡 Explainer' },
          { value: 'Tutorial', label: '🎯 Tutorial' },
          { value: 'Promotional', label: '📢 Promotional' }
        ],
        default: 'Educational'
      }
    ]
  },
  'Article': {
    fields: [
      {
        type: 'select',
        id: 'wordCount',
        label: 'Word Count',
        options: [
          { value: 300, label: '300 words' },
          { value: 500, label: '500 words' },
          { value: 800, label: '800 words' },
          { value: 1200, label: '1200 words' },
          { value: 1500, label: '1500 words' },
          { value: 2000, label: '2000 words' }
        ],
        default: 800
      },
      {
        type: 'select',
        id: 'articleType',
        label: 'Article Type',
        options: [
          { value: 'How-to Guide', label: '📝 How-to Guide' },
          { value: 'Listicle', label: '📋 Listicle' },
          { value: 'Opinion Piece', label: '💭 Opinion Piece' },
          { value: 'News Article', label: '📰 News Article' },
          { value: 'Case Study', label: '📊 Case Study' },
          { value: 'Review', label: '⭐ Review' }
        ],
        default: 'How-to Guide'
      }
    ]
  },
  'Blog Outline': {
    fields: [
      {
        type: 'select',
        id: 'sections',
        label: 'Number of Sections',
        options: [
          { value: 3, label: '3 sections' },
          { value: 5, label: '5 sections' },
          { value: 7, label: '7 sections' },
          { value: 10, label: '10 sections' }
        ],
        default: 5
      }
    ]
  },
  'Headline': {
    fields: [
      {
        type: 'select',
        id: 'headlineCount',
        label: 'Number of Headlines',
        options: [
          { value: 5, label: '5 headlines' },
          { value: 10, label: '10 headlines' },
          { value: 15, label: '15 headlines' },
          { value: 20, label: '20 headlines' }
        ],
        default: 10
      }
    ]
  },
  'Meta Description': {
    fields: [
      {
        type: 'select',
        id: 'metaType',
        label: 'Meta Type',
        options: [
          { value: 'Description', label: '📝 Meta Description' },
          { value: 'Title', label: '🏷️ Meta Title' },
          { value: 'Both', label: '📄 Title & Description' },
          { value: 'Keywords', label: '🔍 Keywords' }
        ],
        default: 'Description'
      }
    ]
  }
};

const PLATFORMS = [
  { id: 'Instagram', emoji: '📸', name: 'Instagram' },
  { id: 'LinkedIn', emoji: '💼', name: 'LinkedIn' },
  { id: 'Twitter', emoji: '🐦', name: 'Twitter' },
  { id: 'TikTok', emoji: '🎵', name: 'TikTok' },
  { id: 'YouTube', emoji: '📺', name: 'YouTube' },
  { id: 'Facebook', emoji: '👥', name: 'Facebook' }
];

const ContentGenerator: React.FC = () => {
  const [task, setTask] = useState('Social Caption');
  const [context, setContext] = useState('');
  const [platform, setPlatform] = useState('LinkedIn');
  const [keywords, setKeywords] = useState('');
  const [tone, setTone] = useState('Friendly');
  const [length, setLength] = useState('Medium');
  const [language, setLanguage] = useState('English');
  const [variations, setVariations] = useState('3');
  const [taskSettings, setTaskSettings] = useState<Record<string, any>>({});
  const [isLoading, setIsLoading] = useState(false);
  const [generatedContent, setGeneratedContent] = useState<GeneratedContent | null>(null);
  const { toast } = useToast();

  useEffect(() => {
    const config = TASK_CONFIGS[task];
    if (config && config.fields) {
      const defaultSettings: Record<string, any> = {};
      config.fields.forEach(field => {
        if (field.default !== undefined) {
          defaultSettings[field.id] = field.default;
        }
      });
      setTaskSettings(defaultSettings);
    } else {
      setTaskSettings({});
    }
  }, [task]);

  const buildPrompt = (formData: any) => {
    const taskSpecificInfo = getTaskSpecificInfo();
    
    return `You are an expert content writer. Create ${formData.variations} high-quality ${formData.task.toLowerCase()} variations in ${formData.language}.

TASK: ${formData.task}
CONTEXT: ${formData.context}
PLATFORM: ${formData.platform}
TONE: ${formData.tone}
LENGTH: ${formData.length}
LANGUAGE: ${formData.language}
KEYWORDS: ${formData.keywords}
${taskSpecificInfo}

IMPORTANT FORMATTING REQUIREMENTS:
${getFormattingRequirements(formData.task)}

Return ONLY a valid JSON object with this exact structure:
{
  "meta": {
    "task": "${formData.task}",
    "platform": "${formData.platform}",
    "language": "${formData.language}",
    "tone": "${formData.tone}",
    "variations_count": ${formData.variations}
  },
  "summary": "Brief description of the content",
  "variations": [
    {
      "id": "v1",
      "title": "Variation title",
      "content": "The actual content text",
      "formatted_content": "HTML formatted content for proper display",
      "character_count": 0,
      "word_count": 0,
      "hashtags": ["tag1", "tag2"],
      "cta": "Call to action",
      "notes": "Additional notes"
    }
  ],
  "seo": {
    "title": "SEO title",
    "description": "Meta description"
  }
}

Rules:
1. Content must be in ${formData.language} language
2. Follow the exact formatting requirements for ${formData.task}
3. Make content platform-appropriate for ${formData.platform}
4. Include proper HTML formatting in formatted_content
5. Calculate accurate character_count and word_count
6. Return ONLY the JSON object, no other text

Generate the content now:`;
  };

  const getFormattingRequirements = (taskType: string) => {
    switch (taskType) {
      case 'Article':
        const wordCount = taskSettings.wordCount || 800;
        return `- Article must be EXACTLY ${wordCount} words
- Use proper HTML structure with h1, h2, h3 headings
- Include introduction, body paragraphs, and conclusion
- Format as: <h1>Title</h1><p>Introduction...</p><h2>Section</h2><p>Content...</p>`;
        
      case 'Script':
        const scriptLength = taskSettings.scriptLength || '2 minutes';
        const scriptType = taskSettings.scriptType || 'Educational';
        return `- Script must be for ${scriptLength} duration
- ${scriptType} style script
- Format with scene headers, character names, dialogue, and action lines
- Use proper script formatting: SCENE HEADER, CHARACTER NAME, (action), dialogue`;
        
      case 'Blog Outline':
        const sections = taskSettings.sections || 5;
        return `- Create exactly ${sections} main sections
- Include introduction and conclusion
- Format as structured outline with main points and sub-points`;
        
      case 'Headline':
        const headlineCount = taskSettings.headlineCount || 10;
        return `- Generate exactly ${headlineCount} unique headlines
- Vary the headline styles (question, how-to, listicle, etc.)
- Each headline should be compelling and platform-appropriate`;
        
      case 'Social Caption':
        const charLimit = taskSettings.characterLimit || 280;
        return `- Must be under ${charLimit} characters
- Include relevant hashtags
- Platform-optimized formatting`;
        
      default:
        return '- Follow standard formatting for the content type';
    }
  };

  const getTaskSpecificInfo = () => {
    const config = TASK_CONFIGS[task];
    if (!config || !config.fields) return '';
    
    let info = '';
    config.fields.forEach(field => {
      const value = taskSettings[field.id];
      if (value !== undefined) {
        info += `${field.label}: ${value}\n`;
      }
    });
    return info;
  };

  const generateContent = async (formData: any) => {
    try {
      const prompt = buildPrompt(formData);
      
      const payload = {
        model: 'gpt-4o-mini',
        messages: [{ role: 'user', content: prompt }],
        temperature: 0.7,
        max_tokens: 3000
      };

      const response = await fetch('/.netlify/functions/generate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        const errorText = await response.text().catch(() => 'Unknown error');
        throw new Error(`Backend error ${response.status}: ${errorText}`);
      }

      const data = await response.json();
      
      if (!data.choices || !data.choices[0] || !data.choices[0].message) {
        throw new Error('Invalid response format from API');
      }

      const content = data.choices[0].message.content;
      
      try {
        return JSON.parse(content);
      } catch (parseError) {
        throw new Error('AI returned invalid JSON. Please try again.');
      }
      
    } catch (error) {
      console.error('Generation error:', error);
      throw error;
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!context.trim()) {
      toast({
        title: "Error",
        description: "Please provide context for content generation.",
        variant: "destructive"
      });
      return;
    }

    const formData = {
      task,
      context: context.trim(),
      platform,
      keywords,
      tone,
      length,
      language,
      variations: parseInt(variations) || 3
    };

    setIsLoading(true);

    try {
      const content = await generateContent(formData);
      setGeneratedContent(content);
      toast({
        title: "Success!",
        description: `Generated ${content.variations?.length || 0} content variations.`
      });
    } catch (error: any) {
      console.error('Error generating content:', error);
      toast({
        title: "Error",
        description: error.message || 'Failed to generate content. Please try again.',
        variant: "destructive"
      });
    } finally {
      setIsLoading(false);
    }
  };

  const copyToClipboard = async (text: string, variationId: string) => {
    try {
      await navigator.clipboard.writeText(text);
      toast({
        title: "Copied!",
        description: "Content copied to clipboard.",
      });
    } catch (error) {
      toast({
        title: "Error",
        description: "Failed to copy content.",
        variant: "destructive"
      });
    }
  };

  const renderTaskSettings = () => {
    const config = TASK_CONFIGS[task];
    if (!config || !config.fields || config.fields.length === 0) return null;

    return (
      <div className="task-settings">
        <h4 className="text-sm font-semibold text-primary mb-3">{task} Settings</h4>
        <div className="space-y-4">
          {config.fields.map(field => (
            <div key={field.id} className="space-y-2">
              <Label className="text-sm font-medium">{field.label}</Label>
              {field.type === 'select' && field.options ? (
                <Select 
                  value={String(taskSettings[field.id] || field.default)} 
                  onValueChange={(value) => setTaskSettings(prev => ({ 
                    ...prev, 
                    [field.id]: field.options?.find(opt => String(opt.value) === value)?.value 
                  }))}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {field.options.map(option => (
                      <SelectItem key={String(option.value)} value={String(option.value)}>
                        {option.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              ) : (
                <Input
                  value={String(taskSettings[field.id] || '')}
                  onChange={(e) => setTaskSettings(prev => ({ ...prev, [field.id]: e.target.value }))}
                  placeholder={field.placeholder}
                />
              )}
            </div>
          ))}
        </div>
      </div>
    );
  };

  const renderContentVariation = (variation: any, index: number) => {
    const getContentClass = () => {
      switch (task) {
        case 'Article':
          return 'article-content';
        case 'Script':
          return 'script-content';
        default:
          return '';
      }
    };

    return (
      <div key={variation.id} className="content-card">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-xl font-bold text-primary flex items-center gap-2">
            <div className="w-8 h-8 bg-gradient-to-r from-primary to-accent rounded-full flex items-center justify-center text-white font-bold text-sm">
              {index + 1}
            </div>
            {variation.title || `Variation ${index + 1}`}
          </h3>
          <Button
            variant="outline"
            size="sm"
            onClick={() => copyToClipboard(variation.content || '', variation.id)}
            className="gap-2"
          >
            <Copy className="w-4 h-4" />
            Copy
          </Button>
        </div>

        <div className="space-y-6">
          <div className={`p-6 bg-card rounded-xl border border-border ${getContentClass()}`}>
            {variation.formatted_content ? (
              <div dangerouslySetInnerHTML={{ __html: variation.formatted_content }} />
            ) : (
              <div className="whitespace-pre-wrap">{variation.content}</div>
            )}
          </div>

          {variation.hashtags && variation.hashtags.length > 0 && (
            <div className="flex flex-wrap gap-2">
              {variation.hashtags.map((tag: string, idx: number) => (
                <Badge key={idx} variant="secondary">#{tag}</Badge>
              ))}
            </div>
          )}

          {variation.cta && (
            <div className="p-4 bg-gradient-to-r from-primary/10 to-accent/10 rounded-lg border border-primary/20">
              <Label className="text-xs font-semibold text-primary mb-2 block">💡 Call to Action</Label>
              <p className="text-sm font-medium">{variation.cta}</p>
            </div>
          )}

          <div className="flex justify-between items-center text-xs text-muted-foreground pt-4 border-t border-border">
            <span className="flex items-center gap-2">
              📊 {variation.character_count || variation.word_count || '—'} {variation.character_count ? 'characters' : 'words'}
            </span>
            {variation.notes && (
              <span className="flex items-center gap-2">
                💡 {variation.notes}
              </span>
            )}
          </div>
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-background">
      <div className="bg-animated" />
      
      <div className="relative z-10 container mx-auto p-6 max-w-7xl">
        {/* Header */}
        <div className="text-center space-y-6 mb-12">
          <div className="inline-flex items-center gap-3 px-6 py-3 bg-gradient-to-r from-primary to-accent rounded-full text-white shadow-lg pulse-glow">
            <Sparkles className="w-6 h-6" />
            <span className="font-semibold text-lg">AI Content Creator</span>
          </div>

          <h1 className="text-6xl font-bold gradient-text mb-4">Content Writing Assistant</h1>
          <p className="text-xl text-muted-foreground max-w-3xl mx-auto leading-relaxed">
            Generate ready-to-publish content for social media, blogs, newsletters, and video scripts with the power of AI
          </p>
        </div>

        <div className="grid xl:grid-cols-2 gap-8">
          {/* Input Form */}
          <Card className="glass-card shadow-lg">
            <CardHeader>
              <CardTitle className="text-2xl font-bold flex items-center gap-3">
                <div className="w-8 h-8 bg-gradient-to-r from-primary to-accent rounded-lg flex items-center justify-center">
                  <Sparkles className="w-5 h-5 text-white" />
                </div>
                Content Generator
              </CardTitle>
              <p className="text-muted-foreground text-lg">Fill in the details below to generate amazing content</p>
            </CardHeader>
            
            <CardContent>
              <form onSubmit={handleSubmit} className="space-y-6">
                {/* Task Type */}
                <div className="space-y-3">
                  <Label className="text-sm font-semibold">Task Type</Label>
                  <Select value={task} onValueChange={setTask}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Social Caption">📱 Social Caption</SelectItem>
                      <SelectItem value="Multi-Platform">🌐 Multi-Platform</SelectItem>
                      <SelectItem value="Blog Outline">📋 Blog Outline</SelectItem>
                      <SelectItem value="Article">📄 Article</SelectItem>
                      <SelectItem value="Script">🎬 Script</SelectItem>
                      <SelectItem value="Headline">📰 Headline</SelectItem>
                      <SelectItem value="Meta Description">🔍 Meta Description</SelectItem>
                      <SelectItem value="Polish Content">✨ Polish Content</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                {/* Context */}
                <div className="space-y-3">
                  <Label className="text-sm font-semibold">Context</Label>
                  <Textarea 
                    value={context}
                    onChange={(e) => setContext(e.target.value)}
                    className="min-h-[120px] resize-none" 
                    placeholder="Describe what you want to create content about..." 
                    required 
                  />
                </div>

                {/* Task-specific settings */}
                {renderTaskSettings()}

                {/* Language Selection */}
                <div className="space-y-3">
                  <Label className="text-sm font-semibold">Language</Label>
                  <Select value={language} onValueChange={setLanguage}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="English">🇺🇸 English</SelectItem>
                      <SelectItem value="Hindi">🇮🇳 Hindi</SelectItem>
                      <SelectItem value="Hinglish">🇮🇳 Hinglish</SelectItem>
                      <SelectItem value="Spanish">🇪🇸 Spanish</SelectItem>
                      <SelectItem value="French">🇫🇷 French</SelectItem>
                      <SelectItem value="German">🇩🇪 German</SelectItem>
                      <SelectItem value="Italian">🇮🇹 Italian</SelectItem>
                      <SelectItem value="Portuguese">🇧🇷 Portuguese</SelectItem>
                      <SelectItem value="Russian">🇷🇺 Russian</SelectItem>
                      <SelectItem value="Japanese">🇯🇵 Japanese</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                {/* Platform Selection */}
                <div className="space-y-3">
                  <Label className="text-sm font-semibold">Platform</Label>
                  <div className="grid grid-cols-3 gap-3">
                    {PLATFORMS.map(p => (
                      <div
                        key={p.id}
                        className={`platform-card ${platform === p.id ? 'selected' : ''}`}
                        onClick={() => setPlatform(p.id)}
                      >
                        <div className="text-2xl mb-2">{p.emoji}</div>
                        <div className="text-xs font-medium">{p.name}</div>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Tone, Length, Variations */}
                <div className="grid grid-cols-3 gap-4">
                  <div className="space-y-3">
                    <Label className="text-sm font-semibold">Tone</Label>
                    <Select value={tone} onValueChange={setTone}>
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="Friendly">😊 Friendly</SelectItem>
                        <SelectItem value="Professional">💼 Professional</SelectItem>
                        <SelectItem value="Witty">😄 Witty</SelectItem>
                        <SelectItem value="Inspirational">✨ Inspirational</SelectItem>
                        <SelectItem value="Educational">🎓 Educational</SelectItem>
                        <SelectItem value="Casual">👋 Casual</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>

                  <div className="space-y-3">
                    <Label className="text-sm font-semibold">Length</Label>
                    <Select value={length} onValueChange={setLength}>
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="Short">📝 Short</SelectItem>
                        <SelectItem value="Medium">📄 Medium</SelectItem>
                        <SelectItem value="Long">📚 Long</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>

                  <div className="space-y-3">
                    <Label className="text-sm font-semibold">Variations</Label>
                    <Select value={variations} onValueChange={setVariations}>
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="1">1</SelectItem>
                        <SelectItem value="2">2</SelectItem>
                        <SelectItem value="3">3</SelectItem>
                        <SelectItem value="4">4</SelectItem>
                        <SelectItem value="5">5</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                </div>

                {/* Keywords */}
                <div className="space-y-3">
                  <Label className="text-sm font-semibold">Keywords (comma-separated)</Label>
                  <Input 
                    value={keywords}
                    onChange={(e) => setKeywords(e.target.value)}
                    placeholder="AI, content creation, social media, marketing..." 
                  />
                </div>

                {/* Generate Button */}
                <Button 
                  type="submit" 
                  disabled={isLoading}
                  className="w-full text-lg py-6 bg-gradient-to-r from-primary to-accent hover:opacity-90 transition-opacity"
                >
                  {isLoading ? (
                    <>
                      <div className="loading-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                      </div>
                      <span>Generating...</span>
                    </>
                  ) : (
                    <>
                      <Sparkles className="w-6 h-6" />
                      <span>Generate Content</span>
                    </>
                  )}
                </Button>
              </form>
            </CardContent>
          </Card>

          {/* Results */}
          <div className="space-y-6">
            {generatedContent ? (
              <>
                {/* Summary */}
                <Card className="content-card">
                  <CardHeader>
                    <CardTitle className="text-xl font-bold text-primary flex items-center gap-2">
                      <CheckCircle className="w-5 h-5" />
                      Content Summary
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <p className="text-lg leading-relaxed">{generatedContent.summary}</p>
                  </CardContent>
                </Card>

                {/* SEO */}
                {generatedContent.seo && (
                  <Card className="content-card">
                    <CardHeader>
                      <CardTitle className="text-xl font-bold text-success flex items-center gap-2">
                        🔍 SEO Optimization
                      </CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-4">
                      <div className="p-4 bg-card rounded-lg">
                        <Label className="text-sm font-semibold mb-2 block">SEO Title</Label>
                        <p className="font-medium">{generatedContent.seo.title}</p>
                      </div>
                      <div className="p-4 bg-card rounded-lg">
                        <Label className="text-sm font-semibold mb-2 block">Meta Description</Label>
                        <p>{generatedContent.seo.description}</p>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {/* Variations */}
                {generatedContent.variations?.map((variation, index) => 
                  renderContentVariation(variation, index)
                )}
              </>
            ) : (
              <Card className="content-card text-center py-20">
                <div className="space-y-4">
                  <Sparkles className="mx-auto h-16 w-16 text-muted-foreground animate-pulse" />
                  <h3 className="text-xl font-semibold text-muted-foreground">Ready to Create Magic?</h3>
                  <p className="text-muted-foreground">Generated content will appear here ✨</p>
                </div>
              </Card>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

export default ContentGenerator;
